---
title: "DataVis Class: Final Project Report"
author: "Group 'Data Wizards': Aishe Memetova, Haotian Bu, Jon White, Vitalii Zakhozhyi"
output: 
  html_document:
    toc: true
    theme: united
---
<h1 align="center" style="color:blue">Exploring cash use as a transit fare payment in Seattle</h1>

Our group is interested in cash use as fare payment method in the Greater Seattle area.

Using the Seattle Sound Transit Data of October-November 2015, we will try to answer the following questions:
1) Are cash payments still have a big stake in transit fare types among riders in Seattle?
2) What type of fare is the most common given different purpose of trips?
3).....

#Data Cleaning Part

First we need to call the libraries to be able to use the packages 

```{r load library, results='hide', warning=FALSE, message=FALSE}
library(ggplot2)
library(scales)
library(dplyr)
```
Then we need to call the data we want to analyze. In our case we call the csv file

```{r import data, results='hide', warning=FALSE, message=FALSE}
linkdata <- read.csv("https://raw.githubusercontent.com/karllovepolicy/Data_Visual_Final_Tutorial/master/Final_Data.csv", stringsAsFactors=FALSE)
str(linkdata)
```

```{r}
#change names of explanatory variables
linkdata <- rename(linkdata,'number_of_trips'='oneway_all_clean', 'vehicle'='hhveh_clean', "income"="hhincome")

unique(linkdata$faretype)
```
We noticed "False" here, need to change it to "Other".
```{r}
linkdata <- linkdata %>% 
  mutate(faretype = recode(faretype, 'FALSE' = "Other"))
```


```{r purpose}
unique(linkdata$purpose)
```

```{r income}
unique(linkdata$income)
```

```{r clean income name}
#the category of income need some work
linkdata <- linkdata %>% mutate(income = recode(income, 
                                    "16,000-$19,999"="$16,000-$19,999",
                                    "12000-15999" ="$12,000-$15,999")) 

```

```{r vehicle}
unique(linkdata$vehicle)
```

```{r number of trips}
unique(linkdata$number_of_trips)
```

```{r get ride of missing values, warning=FALSE, message=FALSE}
mydata1 <- linkdata %>%
  filter(faretype != "#NULL!") %>%
  filter(purpose != "#NULL!") %>% 
  filter(income != "#NULL!") %>% 
  filter(vehicle != "#NULL!") %>% 
  filter(number_of_trips != "#NULL!")
```

```{r multi transform binamiry variable_cash, message=FALSE, warning = FALSE}
# these variable are all characters, we need to transform, some to numeric, some to factor
mydata1$vehicle <- as.numeric(mydata1$vehicle)
# subset, transform faretype and vehicle binary variables, select needed variables:
mydata2 <- mydata1 %>% mutate(cashlove = ifelse(faretype=="Cash", 1, 0), vehicle = ifelse(vehicle>0, 1, 0)) %>% select(faretype, cashlove, purpose, income,  vehicle, number_of_trips) 

#mydata2$faretype <- factor(mydata2$faretype)

# set the right type for dependent variable
#from num to factor
mydata2$cashlove <- factor(mydata2$cashlove)

# set the correct type for explanatory variables
#reset the level of variable "purpose"
mydata2$purpose <- factor(mydata2$purpose) 
#from cha to factor
mydata2$income <- factor(mydata2$income) 
#from num to factor
mydata2$vehicle <- factor(mydata2$vehicle)
#from cha to numeric
mydata2$number_of_trips <- as.numeric(mydata2$number_of_trips)#-1

head(mydata2,5)
# transform explanatory varibles from factor to numeric, add "-1" in command because Factors in R are represented internally as integers and the first factor is 1.
```
Format of variables are right, we are good to go!

```{r export dataset}
#write.csv(mydata2, file = "FinalData.csv")
```


#Question 1: Is cash still used as payment for transit? 
**Finalizing the data frame for univariable ggplot**

We will need to separate data we are interested to analyze (subsetting the data), and calculate the frequences

```{r}
absol_ft=table(mydata2$faretype, exclude = 'nothing')
ft_freq=prop.table(absol_ft)*100
ft_freq_df=as.data.frame(ft_freq) 
names(ft_freq_df)=c("faretype","pct")

#ft_freq_df$faretype <- sort(ft_freq_df$faretype,-ft_freq_df$pct)
#ft_freq_df<- ft_freq_df %>% arrange(faretype,-pct)\
#ft_freq_df$faretype= factor(ft_freq_df$faretype, levels=ft_freq_df$faretype[order()]), ordered=TRUE)
ft_freq_df
```

Now we can build a bar plot to visualize how frequently each of the payment methods is used. Since our primary focus is cash, we want to highlight it by using the red color for the bar which represents cash. 
```{r barplot}
#cols <- ifelse(ft_freq_df$faretype == "Cash", "red","gray50")
#something wrong with color, fix now
base = ggplot(ft_freq_df, aes(x=reorder(faretype, pct),y=pct))
ft_plot1 = base + geom_bar(stat="identity", fill="gray50", width = 0.75)
ft_plot2 = ft_plot1 + labs(title='Do riders still use cash to pay a transit fare in Seattle?', #to label the graph 
                           x ='Type of fare',
                           y = 'Percentage of riders',
                           caption = 'Source: Sound Transit 2015 Onboard Survey Data')
ft_plot3 = ft_plot2 + coord_flip() 
ft_plot4 = ft_plot3 #+ scale_y_continuous(limits=c(0,55),
                                    # breaks = seq(0, 55, by = 5)+ 
                                    # labels=unit_format(suffix = '%')) +
                            #scale_x_discrete(limits=ft_freq_df$faretype)
ft_plot4 = ft_plot3 + geom_text(aes(y = pct,
                                label = paste0(round(pct,2), '%')), 
                                hjust= -0.15, 
                                size = 3)
ft_plot5 = ft_plot4 + theme(panel.background = element_rect(fill = "white", color = "black"),
                            plot.title = element_text(size = 15, hjust = 0.5),
                            plot.caption = element_text(hjust = 1, vjust = -1.2),
                            axis.title.y = element_text(size = 12, hjust = 0.5, vjust = 1.75),
                            axis.title.x = element_text(size = 12, hjust = 0.5, vjust = -1.25))
ft_plot5
```

#Question 2: Who is using cash?

Now, we will try to answer what type of fare is the most common given different purpose of trips and different income groups.

**Cleaning the data and creating the proportion table for faretype VS. Purpose**

We will first need to clean the data so that there are no missing values

```{r}
FarePurpose=table(mydata2$faretype, mydata2$purpose)%>%
         prop.table(margin = 2)%>%   # 2 is % by column
         "*"(100)%>%
         round(3)
```

Same as with the barplot, we will need to create a data frame

```{r dflink}
dfFarePurpose=as.data.frame(FarePurpose)
names(dfFarePurpose)=c('Faretype','Purpose','Percent')
```

**Building the faretype VS. Purpose plot**

```{r barplotfarepurpose}
base  = ggplot(dfFarePurpose, aes(x = reorder(Faretype, Percent), y = Percent))
bars1 = base + geom_bar(stat = "identity")
bars2 = bars1 + facet_wrap( ~ Purpose ,nrow = 1)
bars3 = bars2 + coord_flip() + 
                scale_y_continuous(limits=c(0,80),
                                  labels=scales::unit_format(suffix = '%'))
bars4 = bars3 + geom_text(aes(y = Percent,
                                  label = paste0(round(Percent,1), '%')), 
                                  hjust= -0.15, 
                                  size = 2.5)
bars5 = bars4 + labs(title='What fare type is the most common given different purpose of trips?',
                     x ='Fare type',
                     caption = 'Source: Sound Transit 2015 Onboard Survey Data')
bars6 = bars5 + theme(axis.text.y = element_text(size=8, angle = 30),
                      axis.text.x = element_text(size=7),
                      plot.title = element_text(size = 12, hjust = 0.5),
                      plot.caption = element_text(hjust = 1, vjust = -1.2),
                      axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.75),
                      axis.title.x = element_text(size = 11, hjust = 0.5, vjust = -1.25))
bars6
```

**Cleaning the data and creating the proportion table for faretype VS. Income**
```{r}
FareIncome=table(mydata2$faretype, mydata2$income)%>%
         prop.table(margin = 2)%>%   # 2 is % by column
         "*"(100)%>%
         round(3)
```

Same as with the barplot, we will need to create a data frame

```{r}
dfFareIncome=as.data.frame(FareIncome)
names(dfFareIncome)=c('Faretype','Income_Level','Percent')
```
**Building the faretype VS. Purpose plot**
```{r}
base  = ggplot(dfFareIncome, aes(x = reorder(Faretype, Income_Level), y = Percent))
bars1 = base + geom_bar(stat = "identity")
bars2 = bars1 + facet_wrap( ~Income_Level,nrow = 3)
bars3 = bars2 + coord_flip() + 
                scale_y_continuous(limits=c(0,80),
                                  labels=scales::unit_format(suffix = '%'))
bars4 = bars3 + geom_text(aes(y = Percent,
                                  label = paste0(round(Percent,1), '%')), 
                                  hjust= -0.15, 
                                  size = 2.5)
bars5 = bars4 + labs(title='What fare type is the most common given different income level?',
                     x ='Fare type',
                     caption = 'Source: Sound Transit 2015 Onboard Survey Data')
bars6 = bars5 + theme(axis.text.y = element_text(size=8, angle = 30),
                      axis.text.x = element_text(size=7),
                      plot.title = element_text(size = 12, hjust = 0.5),
                      plot.caption = element_text(hjust = 1, vjust = -1.2),
                      axis.title.y = element_text(size = 11, hjust = 0.5, vjust = 1.75),
                      axis.title.x = element_text(size = 11, hjust = 0.5, vjust = -1.25))
bars6
```

#Question 3: What's the impact of explanatory variables on cash usage?

In this section, we will explore the realationship among the probability of using cash for this trip, whether people have vehicles, the purpose of this trip, and frequency of using public transportation. 


**Doing Regression with logit model** 

Here we use logit model since our dependent variable is a binary variable. Our reference group is people whose purpose of this trip is home-based non-work trip and don't have vehicles at home.
```{r logit regression, message=FALSE, warning=FALSE}
library(dotwhisker)
library(broom)
#just use purpose as explantary variable
mylogit1 <- glm(cashlove ~ purpose, data = mydata2, family = "binomial")
model1 = tidy(mylogit1) %>%   # we save the result as a tidy object and...
    mutate(model = "Model 1")
#use purpose and income
mylogit2 <- glm(cashlove ~ purpose + income, data = mydata2, family = "binomial")
model2 = tidy(mylogit2) %>%   # we save the result as a tidy object and...
    mutate(model = "Model 2")
#use purpose income and vehicle
mylogit3 <- glm(cashlove ~ purpose + income + vehicle, data = mydata2, family = "binomial")
model3 = tidy(mylogit3) %>%   # we save the result as a tidy object and...
    mutate(model = "Model 3")
#use all four explanatory varibales
mylogit4 <- glm(cashlove ~ purpose + income + vehicle + number_of_trips, data = mydata2, family = "binomial")
model4 = tidy(mylogit4) %>%   # we save the result as a tidy object and...
    mutate(model = "Model 4")
summary(mylogit4)
```

**Comparing four models**

```{r compare different models}
allModels=rbind(model1, model2, model3, model4)

dwplot(allModels, vline = geom_vline(xintercept = 0, colour = "grey60", linetype = 2)) + 
  xlab("Coefficient Estimate") + 
  ylab("") +
  ggtitle("Predicting probability of using cash") +
  theme_bw()
```

From the plot above, we can see that compared with reference group, people whose purpose is home based work trip have less probability using cash, while people whose purpose is non-home based trip is more likely to use cash.
The more trips people have in each month, the less likelihood people would use cash. However, the difference on cash usage between people who have vehicles in home and people who don't is non-significant. 





#Question 4: Finding & Conclusion